<div class="grid grid-rows-[55%_45%] h-full w-full">
    <!-- ASCII -->
    <div class="flex items-center justify-center pt-30">
        <div
            class="mx-auto my-8 w-fit rounded-xl border border-white/10 bg-linear-to-br from-zinc-900 to-zinc-800 p-6 shadow-2xl"
        >
            <pre
                class="select-none pointer-events-none cursor-default font-mono text-sm text-zinc-200 m-0">
<span class="text-blue-500">&gt;</span><span id="terminal-cursor">_</span>
⠀⠀⠀⠀⠀⠀⢀⣴⣾⣿⣷⣶⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⢀⣴⣿⣿⣿⣿⣿⣿⣿⣷⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢠⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⢀⣿⣿⣿⡿⠟⠛⢛⣿⣿⣿⣿⣿⣿⣿⣦⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⣾⣿⠟⠁⠀⠀⠀⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⣸⡿⠁⠀⠀⠀⠀⣼⣿⣿⣿⣿⡟⠀⠈⠻⣿⣿⣿⣷⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⢀⡟⠁⠀⠀⠀⠀⢰⣿⣿⣿⣿⡟⠀⠀⠀⠀⠈⠛⢿⣿⣿⣷⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠘⠀⠀⠀⠀⠀⠀⣾⣿⣿⣿⡟⠀⠀⠀⠀⠀⠀⠀⣰⣿⣿⣿⣿⣧⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⢠⣿⣿⣿⣿⠁⠀⠀⠀⠀⠀⠀⢰⣿⠀⢘⣿⣿⣿⣿⣦⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⡀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⠀⠀⠀⠀⠀⠀⠀⣿⣿⣷⣿⣿⣿⣿⣿⣿⣿⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣴⣾⣿⣿⣿⣷⣄⠀
⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⠀⠀⠀⠀⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣴⣿⡿⠻⣿⣿⡇⠀⠈⠂
⠀⠀⠀⠀⠀⠀⠘⣿⣿⣿⣿⣇⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⠟⣹⡿⢿⣿⣿⣶⡀⠀⠀⠀⠀⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⣠⣿⡿⠋⠀⠀⢿⣿⡇⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠻⣿⣿⣿⣿⣧⡀⠀⠀⠀⠀⠀⠻⣿⣿⣿⣭⣵⣾⠟⠁⠀⠙⢿⣿⣿⣦⡀⠀⠀⠀⠀⠀⢸⡇⢀⡾⠀⠀⢀⣾⣿⣿⣣⠀⠀⠀⣾⣿⠃⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠙⢿⣿⣿⣿⣿⣷⣦⣄⡀⠀⠀⠀⠉⠛⠛⠋⠁⠀⠀⠀⠀⠈⠻⣿⣿⣿⣆⠀⠀⠀⠀⣿⣿⣿⡇⢀⣴⡿⢿⣿⣿⡿⠀⠀⣴⣿⡟⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠻⢿⣿⣿⣿⣿⣿⣷⣶⣦⣤⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢻⣿⣿⣷⣤⣤⣼⣿⣿⣿⣷⣾⠟⠁⠀⠉⠉⣀⣴⣾⠿⠋⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠛⠻⠿⣿⣿⣿⣿⣿⣿⣿⣿⣶⣶⣦⣤⣤⣀⣀⣀⣙⢿⣿⣿⣿⣿⣿⠛⣿⣿⣯⣤⠶⠶⠛⠛⠉⠉⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠉⠙⠛⠛⠛⠿⠿⠿⠿⠿⠿⠿⠿⠿⠿⢿⣿⣿⡟⠁⠀⠈⠻⣧⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣴⣿⠟⠉⠀⠀⠀⠀⠀⠀⠉⠉⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣠⡴⠾⠛⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
           </pre>
        </div>
    </div>

    <!-- FORM (45%) -->
    <div class="flex items-start justify-center pt-15">
        <div
            class="flex flex-col items-center justify-center gap-4 mt-6 w-full max-w-4xl relative"
        >
            <input
                id="videoUrl"
                type="url"
                placeholder="Pega la URL del vídeo"
                class="w-full rounded-lg border border-neutral-700 bg-neutral-900 px-4 py-3 text-white placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />

            <div class="relative inline-block w-full">
                <div class="relative w-full flex justify-center">
                    <div
                        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[calc(100%+2rem)] h-[calc(100%+1rem)] bg-linear-to-r from-blue-700 via-white to-blue-500 opacity-50 rounded-xl blur-3xl -z-10 pointer-events-none"
                    >
                    </div>

                    <button
                        id="downloadBtn"
                        class="relative z-10 bg-white text-black px-14 py-3 rounded-lg font-semibold transition-all hover:shadow-2xl hover:shadow-blue-500/50 active:scale-95"
                    >
                        Download
                    </button>
                </div>
                <div
                    id="downloadDropdown"
                    class="absolute left-1/2 -translate-x-1/2 mt-4 w-80 rounded-xl border border-white/10 bg-zinc-900 shadow-2xl z-20 opacity-0 pointer-events-none transition-opacity duration-300"
                >
                    <div
                        class="grid grid-cols-[1fr_1px_1fr] text-sm text-white"
                    >
                        <div class="p-4 flex flex-col gap-2" id="videoOptions">
                            <span class="text-xs uppercase text-zinc-400"
                                >Video</span
                            >
                        </div>
                        <div class="bg-white/10"></div>
                        <div class="p-4 flex flex-col gap-2" id="audioOptions">
                            <span class="text-xs uppercase text-zinc-400"
                                >Audio</span
                            >
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    const btn = document.getElementById("downloadBtn");
    const dropdown = document.getElementById("downloadDropdown");
    const videoBox = document.getElementById("videoOptions");
    const audioBox = document.getElementById("audioOptions");
    const input = document.getElementById("videoUrl");
    const progressBar = document.getElementById("progressBar");

    let dropdownOpen = false;
    let loadingDropdown = false;

    function toggleDropdown(show) {
        dropdownOpen = show;
        if (!dropdown) return;
        if (show) {
            dropdown.classList.remove("opacity-0", "pointer-events-none");
            dropdown.classList.add("opacity-100");
        } else {
            dropdown.classList.add("opacity-0");
            dropdown.classList.remove("opacity-100");
            setTimeout(() => {
                if (!dropdownOpen)
                    dropdown.classList.add("pointer-events-none");
            }, 300);
        }
    }

    function clearOptions() {
        videoBox.innerHTML =
            '<span class="text-xs uppercase text-zinc-400">Vídeo</span>';
        audioBox.innerHTML =
            '<span class="text-xs uppercase text-zinc-400">Audio</span>';
    }

    function makeOption(label, format) {
        const button = document.createElement("button");
        button.textContent = label;
        button.className =
            "text-left px-3 py-2 rounded-md hover:bg-white/10 transition";
        button.onclick = () => startDownload(format);
        return button;
    }

    async function showDropdownOptions() {
        if (!input.value.trim()) return alert("Introduce una URL válida");

        btn.disabled = true;
        btn.textContent = "Loading…";
        clearOptions();

        try {
            const res = await fetch("http://localhost:8000/api/analyze", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url: input.value.trim() }),
            });

            const data = await res.json();

            // Guardamos la resolución de 'best' si viene
            let bestLabel = "";
            data.formats.forEach((f) => {
                if (f.id === "best") bestLabel = f.label;
            });

            data.formats.forEach((f) => {
                if (f.id === "mp3") {
                    audioBox.appendChild(makeOption(f.label, f.id));
                } else {
                    // Si es 1080p y coincide con 'best', no mostrarla
                    if (f.id === "1080p" && f.label === bestLabel) return;
                    videoBox.appendChild(makeOption(f.label, f.id));
                }
            });

            toggleDropdown(true);
        } catch (e) {
            alert("Error al analizar vídeo");
            console.error(e);
        } finally {
            btn.disabled = false;
            btn.textContent = "Download";
        }
    }

    function startDownload(format) {
        toggleDropdown(false);

        window.dispatchEvent(new Event("download-start"));

        const url = encodeURIComponent(input.value.trim());

        const downloadUrl = `http://localhost:8000/api/download?url=${url}&format=${format}`;

        // descarga real del navegador
        window.location.href = downloadUrl;

        // simulamos final (el navegador manda)
        setTimeout(() => {
            window.dispatchEvent(new Event("download-finish"));
        }, 1500);
    }

    // ---------- Listeners ----------
    btn.addEventListener("click", (e) => {
        e.stopPropagation();
        showDropdownOptions();
    });
    input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            showDropdownOptions();
        }
    });
    dropdown.addEventListener("click", (e) => e.stopPropagation());
    document.addEventListener("click", (e) => {
        if (dropdownOpen && !dropdown.contains(e.target) && e.target !== btn)
            toggleDropdown(false);
    });
</script>
<style>
    #terminal-cursor {
        animation: blink 1.7s step-start infinite;
    }

    @keyframes blink {
        0%,
        50% {
            opacity: 1;
        }
        51%,
        100% {
            opacity: 0;
        }
    }
</style>
